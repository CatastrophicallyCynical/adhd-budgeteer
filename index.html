<!doctype html><html lang="en">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Budgeteer</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
  <div class="app-title">Budgeteer</div>
  <div class="affirmation small">Small wins count.</div>
</header>

<div class="container">
  <div class="card">
    <div class="row" style="align-items:center">
      <div class="row" style="gap:8px">
        <button class="btn" id="prev">◀</button>
        <div class="kbd" id="monthTitle"></div>
        <button class="btn" id="next">▶</button>
      </div>
</div>
      <div class="actions">
        <a class="btn" href="expense.html">Add Expense</a>
        <a class="btn" href="income.html">Add Income</a>
        <a class="btn" href="history.html">History</a>
        <a class="btn" href="about.html">About</a>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row"><div style="font-weight:700">Buckets</div>
      <div class="small">Tap ▾ to see this month’s items • ＋ to add to that bucket</div>
    </div>
    <div id="bucketList" class="grid buckets" style="margin-bottom:72px"></div>
  </div>
</div>

<nav class="tabbar">
  <a href="index.html"><span class="ico">🏠</span><span>Home</span></a>
  <a href="expense.html"><span class="ico">➖</span><span>Expense</span></a>
  <a href="income.html"><span class="ico">➕</span><span>Income</span></a>
  <a href="history.html"><span class="ico">📜</span><span>History</span></a>
  <a href="about.html"><span class="ico">⚙️</span><span>About</span></a>
</nav>

<script type="module">
/* Budgeteer home with Spendable summary */
const LS = { expenses:'budgeteer_expenses', income:'budgeteer_income', buckets:'budgeteer_buckets' };
const DEFAULT_BUCKETS = [
  { id:'bills',name:'Bills',emoji:'💡'},{ id:'groceries',name:'Groceries',emoji:'🍎'},
  { id:'eatingout',name:'Eating Out',emoji:'🍔'},{ id:'transport',name:'Transport',emoji:'🚌'},
  { id:'fun',name:'Fun',emoji:'🎮'},{ id:'health',name:'Health',emoji:'🏥'},
  { id:'kids',name:'Kids',emoji:'👶'},{ id:'other',name:'Other',emoji:'📦'},
  { id:'savings',name:'Savings',emoji:'🪙'}
];
const SAVINGS_IDS = ['savings']; // exclude these from spendable expenses

const fmt = n => (Number(n)||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
function load(k,d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch{ return d; } }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function ensureBuckets(){ const b=load(LS.buckets,null); if(!b){ save(LS.buckets,DEFAULT_BUCKETS); return DEFAULT_BUCKETS; } return b; }

function range(y,m){ return [new Date(y,m,1).getTime(), new Date(y,m+1,1).getTime()]; }
function title(y,m){ return new Date(y,m,1).toLocaleString(undefined,{month:'long',year:'numeric'}); }

/* MIGRATION: ensure every expense has id and numeric amount */
(function migrate(){
  const exps = load(LS.expenses, []);
  let touched=false;
  for (const e of exps){
    if (!e.id) { e.id=(crypto?.randomUUID?.()||String(Date.now())+Math.random().toString(16).slice(2)); touched=true; }
    if (typeof e.amount==='string') { e.amount=Number(e.amount)||0; touched=true; }
  }
  if (touched) save(LS.expenses, exps);
})();

let Y=new Date().getFullYear(), M=new Date().getMonth();
document.getElementById('prev').onclick=()=>{ if(--M<0){M=11;Y--;} render(); };
document.getElementById('next').onclick=()=>{ if(++M>11){M=0;Y++;} render(); };

function render(){
  const buckets = ensureBuckets();
  const expsAll = load(LS.expenses, []);
  const incAll  = load(LS.income,   []);
  document.getElementById('monthTitle').textContent = title(Y,M);

  const [s,e]=range(Y,M);
  // Filter by month
  const monthExp = expsAll.filter(x=>{ const ts=new Date((x.date||'')+'T12:00').getTime(); return ts>=s && ts<e; });
  const monthInc = incAll .filter(x=>{ const ts=new Date((x.date||'')+'T12:00').getTime(); return ts>=s && ts<e; });

  // --- Budget math ---
  const incomeTotal = monthInc.reduce((sum,x)=> sum + (Number(x.amount)||0), 0);
  // For expenses, exclude savings buckets; treat any positive by mistake as absolute spend
  const spendNonSavings = monthExp
    .filter(x => !SAVINGS_IDS.includes(x.bucketId))
    .reduce((sum,x)=>{
      const a = Number(x.amount)||0;
      return sum + (a<0 ? -a : Math.abs(a));
    }, 0);

  const spendable = incomeTotal - spendNonSavings;

  // Render summary line
  const summary = document.getElementById('summary');
  summary.innerHTML = `
    <b>Spendable:</b> $${fmt(spendable)}
    &nbsp;•&nbsp; <span class="small">Income: $${fmt(incomeTotal)}</span>
    &nbsp;•&nbsp; <span class="small">Expenses (excl. Savings): $${fmt(spendNonSavings)}</span>
  `;

  // --- Buckets grid ---
  const by = Object.fromEntries(buckets.map(b=>[b.id,[]]));
  monthExp.forEach(x=>{ (by[x.bucketId] ||= []).push(x); });

  const list=document.getElementById('bucketList'); list.innerHTML='';
  for(const b of buckets){
    const items = by[b.id] || [];
    const total = items.reduce((s,x)=> s + (Number(x.amount)||0), 0);
    const card=document.createElement('div');
    card.className='bucket';
    card.innerHTML = `
      <div class="row" style="align-items:center">
        <div class="name"><span class="emoji">${b.emoji}</span> ${b.name}</div>
        <div class="row" style="gap:8px">
          <a class="btn" href="expense.html?bucket=${encodeURIComponent(b.id)}">＋</a>
          <button class="btn" data-expand="${b.id}">▾</button>
        </div>
      </div>
      <div class="small">This month: <b>${fmt(total)}</b></div>
      <div class="bar"><div style="width:${Math.min(100, Math.abs(total))}%"></div></div>
      <div class="details" id="d-${b.id}" style="display:none; margin-top:8px">
        ${
          items.length ? items.map(x=>`
            <div class="row small" data-item="${x.id}">
              <div>${x.date||'—'} • ${(x.note||'—').replace(/</g,'&lt;')}</div>
              <div style="display:flex; gap:6px; align-items:center">
                <span>${fmt(x.amount)}</span>
                <button class="btn" data-edit="${x.id}">Edit</button>
                <button class="btn" data-del="${x.id}">Delete</button>
              </div>
            </div>`).join('') : `<div class="small">No items in ${title(Y,M)}.</div>`
        }
      </div>`;
    list.appendChild(card);
  }

  // expand
  list.querySelectorAll('[data-expand]').forEach(btn=>{
    btn.onclick = ()=>{ const id=btn.getAttribute('data-expand'); const el=document.getElementById('d-'+id); el.style.display = (el.style.display==='none'||!el.style.display)?'block':'none'; };
  });

  // edit
  list.querySelectorAll('[data-edit]').forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute('data-edit');
      const all = load(LS.expenses, []);
      const idx = all.findIndex(x=>x.id===id);
      if (idx<0) return;
      const cur = all[idx];
      const amt = Number(prompt('Amount (negative for expense)', cur.amount));
      if (Number.isNaN(amt)) return;
      const note = prompt('Note', cur.note||'') || '';
      const date = prompt('Date (YYYY-MM-DD)', cur.date || new Date().toISOString().slice(0,10)) || cur.date;
      all[idx] = {...cur, amount: amt, note, date};
      save(LS.expenses, all);
      render();
    };
  });

  // delete
  list.querySelectorAll('[data-del]').forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute('data-del');
      if (!confirm('Delete this item?')) return;
      const all = load(LS.expenses, []);
      save(LS.expenses, all.filter(x=>x.id!==id));
      render();
    };
  });
}

render();
</script>

</body></html>
