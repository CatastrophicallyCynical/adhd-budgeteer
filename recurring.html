<!doctype html><html>
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Recurring</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .rowwrap{display:flex; flex-direction:column; gap:8px}
    .rec-item{display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center}
    .rec-sub{font-size:12px; color:var(--muted)}
    .rec-actions{display:flex; gap:6px}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #cbd5e1}
    .container{max-width:720px}
  </style>
</head>
<body>
<header>
  <div class="app-title">Recurring</div>
  <div class="affirmation small"></div>
</header>

<div class="container">
  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:center">
      <div style="font-weight:700">Scheduled bills & paychecks</div>
      <a class="btn" href="index.html">Done</a>
    </div>
    <div id="list" class="rowwrap"></div>
  </div>
</div>

<nav class="tabbar">
  <a href="index.html"><span class="ico">üè†</span><span>Home</span></a>
  <a href="expense.html"><span class="ico">‚ûñ</span><span>Expense</span></a>
  <a href="income.html"><span class="ico">‚ûï</span><span>Income</span></a>
  <a href="recurring.html"><span class="ico">üîÅ</span><span>Recurring</span></a>
  <a href="about.html"><span class="ico">‚öôÔ∏è</span><span>About</span></a>
</nav>

<script type="module">
import { idb } from './db.js';
await idb.open();

const buckets = await idb.all('buckets');
const byId = Object.fromEntries(buckets.map(b=>[b.id,b]));

function money(n){ return (n>=0?'+':'') + n.toFixed(2); }

async function render(){
  const list = document.getElementById('list');
  list.innerHTML = '';
  const recs = await idb.all('recurring');
  recs.sort((a,b)=> new Date(a.nextDueISO) - new Date(b.nextDueISO));
  if(!recs.length){ list.innerHTML = '<div class="small">No recurring items yet. Add one when saving an expense or income.</div>'; return; }

  for (const r of recs){
    const b = byId[r.bucketId];
    const next = new Date(r.nextDueISO);
    const item = document.createElement('div');
    item.className = 'rec-item';

    item.innerHTML = `
      <div>
        <div style="font-weight:700">${b ? (b.emoji+' '+b.name) : '‚Äî'} ‚Ä¢ ${r.name || (r.type==='income'?'Paycheck':'Recurring')}</div>
        <div class="rec-sub">
          ${r.type==='income'?'Income':'Expense'} ¬∑ ${money(r.amount)} ¬∑ next ${next.toLocaleString()}
          ${r.confirmViaPush ? '<span class="pill">Confirm via push</span>' : ''}
        </div>
      </div>
      <div class="rec-actions">
        <button class="btn" data-act="confirm" data-id="${r.id}">Log now</button>
        <button class="btn" data-act="edit" data-id="${r.id}">Edit</button>
        <button class="btn" data-act="del" data-id="${r.id}">Delete</button>
      </div>
    `;
    list.appendChild(item);
  }

  list.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click', (e)=> handleAction(e.currentTarget.dataset));
  });
}

async function handleAction({act,id}){
  const all = await idb.all('recurring');
  const r = all.find(x=>x.id===id);
  if(!r) return;

  if (act==='del'){
    const req = indexedDB.open('gentle-budget');
    req.onsuccess = ()=> {
      const d=req.result;
      const t=d.transaction('recurring','readwrite').objectStore('recurring').delete(id);
      t.onsuccess = ()=> { alert('Deleted'); render(); };
    };
    return;
  }

  if (act==='confirm'){
    const input = prompt(`Amount to log for "${r.name}"`, r.amount.toFixed(2));
    if(!input) return;
    const amt = Number(input);
    const tx = {
      id: crypto.randomUUID(),
      ts: Date.now(),
      amount: (r.type==='income'?+amt:-Math.abs(amt)),
      bucketId: r.bucketId||'',
      note: `recurring: ${r.name}`
    };
    await idb.put('transactions', tx);

    const next = new Date(r.nextDueISO);
    if (r.cadence==='weekly')      next.setDate(next.getDate()+7);
    else if (r.cadence==='biweekly') next.setDate(next.getDate()+14);
    else /* monthly */             next.setMonth(next.getMonth()+1);
    r.nextDueISO = next.toISOString();
    await idb.put('recurring', r);

    alert('Logged'); render(); return;
  }

  if (act==='edit'){
    const amount = Number(prompt('New amount', r.amount));
    if (!isNaN(amount)) r.amount = amount;
    const when = prompt('Next due (YYYY-MM-DD HH:mm)', r.nextDueISO.slice(0,16).replace('T',' '));
    if (when){
      const [d,t] = when.split(' ');
      const [Y,M,D] = d.split('-').map(Number);
      const [h,m] = (t||'12:00').split(':').map(Number);
      r.nextDueISO = new Date(Y, M-1, D, h, m).toISOString();
    }
    r.confirmViaPush = confirm('Confirm via push? OK=yes / Cancel=no');
    await idb.put('recurring', r);
    alert('Updated'); render();
  }
}

render();
</script>
</body></html>
