<!doctype html><html>
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Add Income</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
  <div class="card">
    <h2>Add Income</h2>

    <label>Amount</label>
    <input type="number" id="amount" inputmode="decimal" placeholder="0.00" step="0.01">

    <label>Date</label>
    <input type="date" id="date">

    <label>Bucket (optional)</label>
    <select id="bucket">
      <option value="">â€” No bucket (general) â€”</option>
    </select>

    <label>Note (optional)</label>
    <input type="text" id="note" placeholder="Paycheck, cash tip, refundâ€¦">

    <label style="display:flex; align-items:center; gap:8px; margin-top:8px">
      <input type="checkbox" id="recurring"> Make this recurring (paycheck)
    </label>
    <div id="recurringFields" style="display:none">
      <label>Cadence</label>
      <select id="cadence">
        <option value="biweekly">Biweekly</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
        <option value="lastday">Last day of month</option>
      </select>

      <label>Typical payday (date)</label>
      <input type="number" id="dueDay" min="1" max="31" placeholder="15">

      <label>Time</label>
      <input type="time" id="dueTime" value="12:00">

      <label style="display:flex; align-items:center; gap:8px; margin-top:8px">
        <input type="checkbox" id="confirmPush" checked> Ask me to confirm via notification
      </label>
    </div>

   <div class="actions">
  <button class="btn" id="cancel">Cancel</button>
  <button class="btn primary" id="save">Save</button>
</div>
<script type="module">
document.getElementById('cancel').onclick = ()=> history.back();
</script>
    </div>
  </div>
</div>

<nav class="tabbar">
  <a href="index.html"><span class="ico">ğŸ </span><span>Home</span></a>
  <a href="expense.html"><span class="ico">â–</span><span>Expense</span></a>
  <a href="income.html"><span class="ico">â•</span><span>Income</span></a>
  <a href="recurring.html"><span class="ico">ğŸ”</span><span>Recurring</span></a>
  <a href="about.html"><span class="ico">âš™ï¸</span><span>About</span></a>
</nav>

<script type="module">
import { applyTheme } from './theme.js'; await applyTheme();
import { idb } from './db.js';
await idb.open();
document.getElementById('date').value = new Date().toISOString().slice(0,10);

const sel = document.getElementById('bucket');
const buckets = await idb.all('buckets');
for(const b of buckets){
  const opt = document.createElement('option');
  opt.value = b.id; opt.textContent = `${b.emoji} ${b.name}`;
  sel.appendChild(opt);
}

document.getElementById('recurring').addEventListener('change', (e)=>{
  document.getElementById('recurringFields').style.display = e.target.checked ? 'block' : 'none';
});

document.getElementById('save').addEventListener('click', async ()=>{
  const amt = parseFloat(document.getElementById('amount').value || '0');
  if(!amt || amt<=0){ alert('Enter amount'); return; }

  const [Y,M,D] = (document.getElementById('date').value || new Date().toISOString().slice(0,10)).split('-').map(Number);
  const ts = new Date(Y, M-1, D, 12, 0).getTime();

  const tx = { id: crypto.randomUUID(), ts, amount: Math.abs(amt), bucketId: sel.value || null, note: document.getElementById('note').value||'' };
  await idb.put('transactions', tx);

  if (document.getElementById('recurring').checked){
    const cadence = document.getElementById('cadence').value;
    const dueDay = parseInt(document.getElementById('dueDay').value||'15',10);
    const dueTime = document.getElementById('dueTime').value || '12:00';
    const confirmPush = document.getElementById('confirmPush').checked;

    const now = new Date();
    let year = now.getFullYear(), month = now.getMonth();
    let day = cadence==='lastday' ? new Date(year, month+1, 0).getDate() : dueDay;
    const [hh,mm] = dueTime.split(':').map(Number);
    let next = new Date(year, month, day, hh, mm);
    if (next < now) {
      if (cadence==='weekly')        next = new Date(now.getTime()+7*86400000);
      else if (cadence==='biweekly') next = new Date(now.getTime()+14*86400000);
      else { month += 1; next = new Date(year, month, day, hh, mm); }
    }

    const rec = {
      id: crypto.randomUUID(),
      name: document.getElementById('note').value || 'Paycheck',
      bucketId: sel.value || '',
      amount: Math.abs(amt),
      currency: 'USD',
      cadence: cadence==='lastday' ? 'monthly' : cadence,
      dayRule: { day: cadence==='lastday' ? 'last' : dueDay },
      nextDueISO: next.toISOString(),
      confirmViaPush: confirmPush,
      autopay: false,
      type: 'income'
    };
    await idb.put('recurring', rec);
  }

  alert('Saved');
  window.close();
});
</script>
</body></html>
